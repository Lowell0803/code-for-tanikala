<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Voting Receipt</title>
    <link rel="stylesheet" type="text/css" href="/css/index.css" />
    <link rel="stylesheet" type="text/css" href="/voter/css/index-voter.css" />
    <link rel="stylesheet" type="text/css" href="/voter/css/verify.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <style>
      /* Ensure long hashes break properly */
      .hash-break {
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <!-- Header (unchanged) -->
    <header class="header">
      <div class="header-logo">
        <img src="/img/logo_tanikala.png" alt="Tanikala Voting System" />
      </div>
      <nav class="header-nav">
        <ul class="header-nav-content">
          <li>Vote</li>
          <p>|</p>
          <li>Review</li>
          <p>|</p>
          <li id="active-link">Verify</li>
          <div class="settings">
            <i class="fa-solid fa-user"></i>
            <div class="dropdown" onclick="toggleDropdownVoter()"></div>
            <div class="dropdown-menu">
              <a href="/edit-account">Logged in as <span>Microsoft Email</span></a>
              <hr class="dropdown-line" />
              <a href="/voter/logout">Log Out</a>
            </div>
          </div>
        </ul>
      </nav>
      <div class="header-bottom-line"></div>
    </header>

    <!-- Content Section -->
    <div class="content">
      <br />
      <div class="main-first">
        <img src="/img/logo_bulsu.png" class="main-first-logo" alt="BulSU Logo" />
        <div class="first-text">
          <h2 class="title">
            BulSU Student Government Elections<br />
            S.Y. 2025 - 2026
          </h2>
        </div>
        <img src="/img/logo_bulsu_ucse.png" class="main-first-logo" alt="BulSU UCSE Logo" />
      </div>

      <!-- Receipt Container -->
      <div id="receiptContainer" class="content-main receipt-container">
        <div class="verify">
          <div class="row">
            <div class="column box-shadow">
              <div class="d-flex">
                <img src="/img/logo_tanikala.png" />
              </div>
              <br />
              <!-- <div class="d-flex justify-content-between">
                <strong>Student Copy</strong>
              </div> -->
              <div class="d-flex flex-col justify-content-center">
                <h3 class="align-center title">Voting Receipt</h3>
              </div>
              <br />
              <hr />
              <br />
              <div class="d-flex flex-col justify-content-center">
                <h4>
                  Voter ID: <br />
                  <span class="hash-break"><%= voterHash %></span>
                </h4>
              </div>
              <br />
              <!-- Candidate selections table -->
              <table>
                <thead>
                  <tr>
                    <th scope="col left">Position</th>
                    <th scope="col right" colspan="2">Candidate(s)</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (candidates && candidates.president) { %>
                  <tr>
                    <td data-label="Position">President</td>
                    <td data-label="Candidate" colspan="2"><% if (Array.isArray(candidates.president)) { %> <%= candidates.president.map(c => c.name).join(', ') %> <% } else { %> <%= candidates.president.name %> <% } %></td>
                  </tr>
                  <% } %> <% if (candidates && candidates.vicePresident) { %>
                  <tr>
                    <td data-label="Position">Vice President</td>
                    <td data-label="Candidate" colspan="2"><% if (Array.isArray(candidates.vicePresident)) { %> <%= candidates.vicePresident.map(c => c.name).join(', ') %> <% } else { %> <%= candidates.vicePresident.name %> <% } %></td>
                  </tr>
                  <% } %> <% if (candidates && candidates.senator) { %>
                  <tr>
                    <td data-label="Position">Senator(s)</td>
                    <td data-label="Candidate" colspan="2"><% if (Array.isArray(candidates.senator)) { %> <%= candidates.senator.map(c => c.name).join(', ') %> <% } else { %> <%= candidates.senator.name %> <% } %></td>
                  </tr>
                  <% } %> <% if (candidates && candidates.governor) { %>
                  <tr>
                    <td data-label="Position">Governor</td>
                    <td data-label="Candidate" colspan="2"><% if (Array.isArray(candidates.governor)) { %> <%= candidates.governor.map(c => c.name).join(', ') %> <% } else { %> <%= candidates.governor.name %> <% } %></td>
                  </tr>
                  <% } %> <% if (candidates && candidates.viceGovernor) { %>
                  <tr>
                    <td data-label="Position">Vice Governor</td>
                    <td data-label="Candidate" colspan="2"><% if (Array.isArray(candidates.viceGovernor)) { %> <%= candidates.viceGovernor.map(c => c.name).join(', ') %> <% } else { %> <%= candidates.viceGovernor.name %> <% } %></td>
                  </tr>
                  <% } %> <% if (candidates && candidates.boardMember) { %>
                  <tr>
                    <td data-label="Position">Board Member</td>
                    <td data-label="Candidate" colspan="2"><% if (Array.isArray(candidates.boardMember)) { %> <%= candidates.boardMember.map(c => c.name).join(', ') %> <% } else { %> <%= candidates.boardMember.name %> <% } %></td>
                  </tr>
                  <% } %>
                </tbody>
              </table>
              <hr />
              <br />
              <div class="d-flex justify-content-between">
                <strong>College</strong>
                <span id="collegeDisplay"><%= voterCollege %></span>
              </div>
              <hr />
              <div class="d-flex justify-content-between">
                <strong>Program</strong>
                <span><%= voterProgram %></span>
              </div>
              <br />
              <hr />
              <div class="d-flex flex-col">
                <span>Votes Submitted To Blockchain</span>
                <span>
                  Transaction Hash:
                  <span class="hash-break" id="txHashDisplay"><%= txHash %></span>
                </span>
                <span>Thank You.</span>
              </div>
              <br />
              <div class="d-flex">
                <span>Date:</span>
                <span><%= new Date().toLocaleString() %></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Export Button (if needed) -->
      <div style="text-align: center; margin: 20px">
        <button id="exportBtn" style="border-radius: 6px; padding: 10px 20px; font-size: 16px" class="button-save">Export Receipt as Image</button>
      </div>
    </div>

    <footer class="footer">
      <div class="footer-left">
        <img src="/img/calendar.png" class="footer-img" />
        <p id="datetime" data-date="<%= electionConfig.fakeCurrentDate %>"></p>
      </div>
      <div class="footer-center">
        <img src="/img/copyright.png" class="footer-img" id="copyright-img" />
        <p>2025 - Fourmula 1</p>
      </div>
      <div class="footer-right"></div>
    </footer>

    <!-- Include Socket.IO client library -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
      // Optionally, if you want real-time updates on the receipt page,
      // you could still use Socket.IO to listen for any final updates.
      const socket = io();
      const voteId = "<%= voteId %>";
      socket.emit("joinVoteRoom", { voteId });
      socket.on("voteError", (data) => {
        // You might show an error message if needed.
        console.error("Vote Error: ", data.error);
      });
    </script>

    <!-- Your existing client-side scripts (export, datetime update, etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.10.3/dist/html-to-image.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var collegeMap = {
          CAFA: "College of Architecture and Fine Arts",
          CAL: "College of Arts and Letters",
          CBEA: "College of Business Education and Accountancy",
          CCJE: "College of Criminal Justice Education",
          COE: "College of Engineering",
          COED: "College of Education",
          CHTM: "College of Hospitality and Tourism Management",
          CIT: "College of Industrial Technology",
          CICT: "College of Information and Communications Technology",
          CON: "College of Nursing",
          CS: "College of Science",
          CSSP: "College of Social Sciences and Philosophy",
          CSER: "College of Sports, Exercise, and Recreation",
        };
        var collegeElem = document.getElementById("collegeDisplay");
        if (collegeElem) {
          var acronym = collegeElem.textContent.trim();
          collegeElem.textContent = collegeMap[acronym] || acronym;
        }

        document.getElementById("exportBtn").addEventListener("click", function () {
          htmlToImage
            .toPng(document.querySelector(".receipt-container"))
            .then(function (dataUrl) {
              var link = document.createElement("a");
              link.download = "receipt.png";
              link.href = dataUrl;
              link.click();
            })
            .catch(function (error) {
              console.error("Oops, something went wrong!", error);
            });
        });
      });
    </script>
    <script>
      function formatDate(isoString) {
        const date = new Date(isoString);
        const options = {
          month: "long",
          day: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        };
        return date.toLocaleString("en-US", options).toUpperCase();
      }
      function updateDateTime() {
        const datetimeElement = document.getElementById("datetime");
        if (!datetimeElement) return;
        let currentTime = new Date(datetimeElement.getAttribute("data-date"));
        function update() {
          datetimeElement.textContent = formatDate(currentTime);
          currentTime.setMinutes(currentTime.getMinutes() + 1);
        }
        update();
        setInterval(update, 60000);
      }
      document.addEventListener("DOMContentLoaded", updateDateTime);
    </script>
    <script src="js/index.js"></script>
    <script src="js/dropdown.js"></script>
  </body>
</html>
