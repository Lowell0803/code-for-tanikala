<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Voting System</title>

    <link rel="stylesheet" type="text/css" href="voter/css/index_voter.css" />
    <link rel="stylesheet" type="text/css" href="voter/css/review.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet" />

    <style>
      .loading-bar-container {
        width: 100%;
        height: 5px;
        background: #ddd;
        position: relative;
        overflow: hidden;
        margin-top: 10px;
      }

      .loading-bar {
        width: 0%;
        height: 100%;
        background: black;
        position: absolute;
        animation: loading-animation 2s infinite linear;
      }

      @keyframes loading-animation {
        0% {
          width: 0%;
        }
        50% {
          width: 50%;
        }
        100% {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <header class="header">
      <div class="header-logo">
        <img src="img/logo_tanikala.png" alt="Tanikala Voting System" />
      </div>
      <nav class="header-nav">
        <ul class="header-nav-content">
          <li><a href="/vote">Vote</a></li>
          <li><a href="/review" id="active-link">Review</a></li>
          <li><a href="verify.html">Verify</a></li>
        </ul>
      </nav>
      <div class="header-bottom-line"></div>
    </header>

    <div class="content">
      <br />
      <div class="content-header">
        <div class="content-header-bulsu">
          <img src="img/logo_bulsu.png" />
        </div>
        <div class="content-header-text">
          <h1>BulSU Student Government Elections<br />S.Y. 2025 - 2026</h1>
        </div>
        <div class="content-header-ucse">
          <img src="img/logo_bulsu_ucse.png" />
        </div>
      </div>

      <div class="content-main">
        <p><i>Please REVIEW your votes before SUBMITTING BALLOT to the Blockchain</i></p>
        <br />
        <div class="review">
          <br />
          <h3 class="ballot-header ballot-council">Vote Summary</h3>

          <h3 class="ballot-header ballot-position">BulSU Supreme Student Council S.Y. 2025-2026</h3>
          <br />
          <ul>
            <li>
              <div class="card">
                <div class="smallIcon">
                  <div class="Icon"><img src="<%= votes.president.image %>" /></div>
                  <div class="Name"><h2><%= votes.president.name %></h2></div>
                  <div class="Roles"><h2><%= votes.president.position %></h2></div>
                  <div class="Description"><p><%= votes.president.moreInfo %></p></div>
                </div>
              </div>
            </li>
            <br />
            <li>
              <div class="card">
                <div class="smallIcon">
                  <div class="Icon"><img src="<%= votes.vicePresident.image %>" /></div>
                  <div class="Name"><h2><%= votes.vicePresident.name %></h2></div>
                  <div class="Roles"><h2><%= votes.vicePresident.position %></h2></div>
                  <div class="Description"><p><%= votes.vicePresident.moreInfo %></p></div>
                </div>
              </div>
            </li>
            <br />
            <li>
              <div class="senator-cards">
                <% votes.senator.forEach((senator) => { %>
                <div class="card">
                  <div class="smallIcon">
                    <div class="Icon"><img src="<%= senator.image %>" /></div>
                    <div class="Name"><h2><%= senator.name %></h2></div>
                    <div class="Roles"><h2><%= senator.position %></h2></div>
                    <div class="Description"><p><%= senator.moreInfo %></p></div>
                  </div>
                </div>
                <br />
                <% }); %>
              </div>
            </li>
            <li>
              <div class="card">
                <div class="smallIcon">
                  <div class="Icon"><img src="<%= votes.governor.image %>" /></div>
                  <div class="Name"><h2><%= votes.governor.name %></h2></div>
                  <div class="Roles"><h2><%= votes.governor.position %></h2></div>
                  <div class="Description"><p><%= votes.governor.moreInfo %></p></div>
                </div>
              </div>
            </li>
            <br />
            <li>
              <div class="card">
                <div class="smallIcon">
                  <div class="Icon"><img src="<%= votes.viceGovernor.image %>" /></div>
                  <div class="Name"><h2><%= votes.viceGovernor.name %></h2></div>
                  <div class="Roles"><h2><%= votes.viceGovernor.position %></h2></div>
                  <div class="Description"><p><%= votes.viceGovernor.moreInfo %></p></div>
                </div>
              </div>
            </li>
            <br />
            <li>
              <div class="card">
                <div class="smallIcon">
                  <div class="Icon"><img src="<%= votes.boardMember.image %>" /></div>
                  <div class="Name"><h2><%= votes.boardMember.name %></h2></div>
                  <div class="Roles"><h2><%= votes.boardMember.position %></h2></div>
                  <div class="Description"><p><%= votes.boardMember.moreInfo %></p></div>
                </div>
              </div>
            </li>
            <br />
          </ul>
          <form id="voteForm">
            <input type="hidden" id="voterHash" value="2021200246@ms.bulsu.edu.ph" />

            <div class="button-container">
              <button class="button-back" type="button" onclick="window.location.href='/vote'">
                <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12H4.5m0 0l6.75-6.75M4.5 12l6.75 6.75"></path>
                </svg>

                <div class="text">Go Back</div>
              </button>

              <input type="hidden" id="voteData" value="<%= JSON.stringify(votes) %>" />
              <!-- <input type="button" id="submitBtn" value="Submit Votes to Blockchain" onclick="submitVote()" /> -->
              <!-- From Uiverse.io by ilkhoeri -->
              <button type="submit" id="submitBtn" value="Submit Votes to Blockchain" onclick="submitVote()" type="button" class="button">
                <span class="fold"></span>

                <div class="points_wrapper">
                  <i class="point"></i>
                  <i class="point"></i>
                  <i class="point"></i>
                  <i class="point"></i>
                  <i class="point"></i>
                  <i class="point"></i>
                  <i class="point"></i>
                  <i class="point"></i>
                  <i class="point"></i>
                  <i class="point"></i>
                </div>

                <span class="inner">
                  <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5">
                    <polyline points="13.18 1.37 13.18 9.64 21.45 9.64 10.82 22.63 10.82 14.36 2.55 14.36 13.18 1.37"></polyline>
                  </svg>
                  <span>Submit Votes</span>
                </span>
              </button>
            </div>
          </form>

          <br /><br />
          <hr />

          <!-- Queue Position Indicator -->
          <p id="queuePosition" style="font-weight: bold; color: black; display: block">Queue Position: <span id="queueNumber"></span></p>

          <hr />
          <br />
          <div id="loading-bar" class="loading-bar-container" style="display: none">
            <div class="loading-bar"></div>
          </div>
          <br /><br /><br />
          <!-- Loading Bar (Initially Hidden) -->

          <!-- <script>
            async function submitVote() {
              const votes = JSON.parse(document.getElementById("voteData").value);
              console.log("Submitting votes:", votes);

              try {
                const response = await fetch("/submit-vote", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ votes }),
                });

                const data = await response.json();
                alert(data.message);
              } catch (error) {
                console.error("Error submitting vote:", error);
                alert("Failed to submit votes.");
              }
            }
          </script> -->

          <!-- <script>
            async function submitVote() {
              let votes = JSON.parse(document.getElementById("voteData").value);
              console.log("üì° Original votes:", votes);

              // ‚úÖ Get logged-in voter's college and program
              const voterCollege = "<%= voterCollege %>";
              const voterProgram = "<%= voterProgram %>";

              // ‚úÖ Reformat LSC votes before submission
              let formattedVotes = {
                President: votes.president,
                "Vice President": votes.vicePresident,
                Senator: votes.senator,
              };

              if (votes.governor) {
                formattedVotes[`Governor - ${voterCollege}`] = votes.governor;
              }
              if (votes.viceGovernor) {
                formattedVotes[`Vice Governor - ${voterCollege}`] = votes.viceGovernor;
              }
              if (votes.boardMember) {
                formattedVotes[`Board Member - ${voterProgram}`] = votes.boardMember;
              }

              console.log("üì° Reformatted votes:", formattedVotes);

              // ‚úÖ Show Loading Bar & Disable Button
              let loadingBar = document.getElementById("loading-bar");
              let submitBtn = document.getElementById("submitBtn");

              loadingBar.style.display = "block"; // ‚úÖ Ensure it's visible
              submitBtn.disabled = true;

              try {
                const response = await fetch("/submit-vote", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ votes: formattedVotes }),
                });

                const data = await response.json();
                alert(data.message);
              } catch (error) {
                console.error("‚ùå Error submitting vote:", error);
                alert("Failed to submit votes.");
              } finally {
                // ‚úÖ Delay hiding the loading bar to ensure visibility
                setTimeout(() => {
                  loadingBar.style.display = "none";
                  submitBtn.disabled = false;
                }, 500); // Ensures visibility for at least 500ms
              }
            }
          </script> -->

          <!-- <script>
            async function submitVote() {
              let votes = JSON.parse(document.getElementById("voteData").value);
              console.log("üì° Original votes:", votes);

              // ‚úÖ Get logged-in voter's college and program
              const voterCollege = "<%= voterCollege %>";
              const voterProgram = "<%= voterProgram %>";

              // ‚úÖ Reformat LSC votes before submission
              let formattedVotes = {
                President: votes.president,
                "Vice President": votes.vicePresident,
                Senator: votes.senator,
              };

              if (votes.governor) {
                formattedVotes[`Governor - ${voterCollege}`] = votes.governor;
              }
              if (votes.viceGovernor) {
                formattedVotes[`Vice Governor - ${voterCollege}`] = votes.viceGovernor;
              }
              if (votes.boardMember) {
                formattedVotes[`Board Member - ${voterProgram}`] = votes.boardMember;
              }

              console.log("üì° Reformatted votes:", formattedVotes);

              // ‚úÖ Show Loading Bar & Disable Button
              let loadingBar = document.getElementById("loading-bar");
              let submitBtn = document.getElementById("submitBtn");
              let queuePosition = document.getElementById("queuePosition");
              let queueNumber = document.getElementById("queueNumber");

              loadingBar.style.display = "block"; // ‚úÖ Ensure it's visible
              submitBtn.disabled = true;
              queuePosition.style.display = "block"; // ‚úÖ Show queue position text
              queueNumber.innerText = "üîÑ Fetching queue position...";

              try {
                // ‚úÖ Get queue position before submitting
                let queueResponse = await fetch("/get-queue-position");
                let queueData = await queueResponse.json();
                queueNumber.innerText = queueData.position; // ‚úÖ Update queue position

                const response = await fetch("/submit-vote", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  // body: JSON.stringify({ votes: formattedVotes }),
                  body: JSON.stringify({ votes: formattedVotes, voterHash }),
                });

                const data = await response.json();

                if (data.transactions) {
                  alert("‚úÖ Vote Submitted! See console for transaction hashes.");
                  console.log("üìú Transaction Hashes:", data.transactions);
                  for (let [position, hash] of Object.entries(data.transactions)) {
                    console.log(`üìú ${hash.txHash}`);
                  }
                }

                alert(data.message);
              } catch (error) {
                console.error("‚ùå Error submitting vote:", error);
                alert("Failed to submit votes.");
              } finally {
                // ‚úÖ Delay hiding the loading bar to ensure visibility
                setTimeout(() => {
                  loadingBar.style.display = "none";
                  submitBtn.disabled = false;
                  queuePosition.style.display = "none"; // ‚úÖ Hide queue position after submission
                }, 500); // Ensures visibility for at least 500ms
              }
            }
          </script> -->

          <!-- <script>
            async function submitVote() {
              let votes = JSON.parse(document.getElementById("voteData").value);
              console.log("üì° Original votes:", votes);

              // ‚úÖ Get the voter hash from the hidden input field
              let voterHash = document.getElementById("voterHash").value;
              console.log("üì° Voter Email for Hashing:", voterHash);

              if (!voterHash) {
                alert("‚ùå Missing voter hash!");
                return;
              }

              // ‚úÖ Hash the voter email before sending it to the server
              let hashedVoterHash = await sha256(voterHash);
              console.log("üîê Hashed Voter Hash:", hashedVoterHash);

              // ‚úÖ Get logged-in voter's college and program
              const voterCollege = "<%= voterCollege %>";
              const voterProgram = "<%= voterProgram %>";

              // ‚úÖ Reformat LSC votes before submission
              let formattedVotes = {
                President: votes.president,
                "Vice President": votes.vicePresident,
                Senator: votes.senator,
              };

              if (votes.governor) {
                formattedVotes[`Governor - ${voterCollege}`] = votes.governor;
              }
              if (votes.viceGovernor) {
                formattedVotes[`Vice Governor - ${voterCollege}`] = votes.viceGovernor;
              }
              if (votes.boardMember) {
                formattedVotes[`Board Member - ${voterProgram}`] = votes.boardMember;
              }

              console.log("üì° Reformatted votes:", formattedVotes);

              try {
                const response = await fetch("/submit-vote", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ votes: formattedVotes, voterHash: hashedVoterHash }),
                });

                const data = await response.json();

                if (data.transactionHash) {
                  alert("‚úÖ Vote Submitted! Transaction Hash: " + data.transactionHash);
                } else {
                  alert("‚ùå Submission failed: " + data.error);
                }
              } catch (error) {
                console.error("‚ùå Error submitting vote:", error);
                alert("Failed to submit votes.");
              }
            }

            // ‚úÖ SHA-256 Hash Function
            async function sha256(input) {
              const encoder = new TextEncoder();
              const data = encoder.encode(input);
              const hashBuffer = await crypto.subtle.digest("SHA-256", data);
              const hashArray = Array.from(new Uint8Array(hashBuffer));
              return hashArray.map((byte) => byte.toString(16).padStart(2, "0")).join("");
            }
          </script> -->

          <script>
            async function submitVote() {
              let votes = JSON.parse(document.getElementById("voteData").value);
              console.log("üì° Original votes:", votes);

              // ‚úÖ Get the voter hash from the hidden input field
              let voterHash = document.getElementById("voterHash").value;
              console.log("üì° Voter Email for Hashing:", voterHash);

              if (!voterHash) {
                alert("‚ùå Missing voter hash!");
                return;
              }

              // ‚úÖ Hash the voter email before sending it to the server
              let hashedVoterHash = await sha256(voterHash);
              console.log("üîê Hashed Voter Hash:", hashedVoterHash);

              // ‚úÖ Get logged-in voter's college and program
              const voterCollege = "<%= voterCollege %>";
              const voterProgram = "<%= voterProgram %>";

              // ‚úÖ Reformat LSC votes before submission
              let formattedVotes = {
                President: votes.president,
                "Vice President": votes.vicePresident,
                Senator: votes.senator,
              };

              if (votes.governor) {
                formattedVotes[`Governor - ${voterCollege}`] = votes.governor;
              }
              if (votes.viceGovernor) {
                formattedVotes[`Vice Governor - ${voterCollege}`] = votes.viceGovernor;
              }
              if (votes.boardMember) {
                formattedVotes[`Board Member - ${voterProgram}`] = votes.boardMember;
              }

              console.log("üì° Reformatted votes:", formattedVotes);

              try {
                // ‚úÖ Show Loading Indicator
                let loadingBar = document.getElementById("loading-bar");
                let submitBtn = document.getElementById("submitBtn");
                loadingBar.style.display = "block";
                submitBtn.disabled = true;

                const response = await fetch("/submit-vote", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ votes: formattedVotes, voterHash: hashedVoterHash }),
                });

                // ‚úÖ Wait for the response and check status
                const data = await response.json();

                if (response.ok) {
                  console.log("‚úÖ Transaction Successful:", data.transactionHash);
                  alert("‚úÖ Vote Submitted! Transaction Hash: " + data.transactionHash);
                } else {
                  console.error("‚ùå Submission failed:", data.error);
                  alert("‚ùå Submission failed: " + data.error);
                }
              } catch (error) {
                console.error("‚ùå Error submitting vote:", error);
                alert("‚ùå Failed to submit votes. Please check the console for details.");
              } finally {
                // ‚úÖ Hide Loading Indicator After Completion
                setTimeout(() => {
                  loadingBar.style.display = "none";
                  submitBtn.disabled = false;
                }, 500);
              }
            }

            // ‚úÖ SHA-256 Hash Function
            async function sha256(input) {
              const encoder = new TextEncoder();
              const data = encoder.encode(input);
              const hashBuffer = await crypto.subtle.digest("SHA-256", data);
              const hashArray = Array.from(new Uint8Array(hashBuffer));
              return hashArray.map((byte) => byte.toString(16).padStart(2, "0")).join("");
            }
          </script>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="footer-left">
        <p>OCTOBER 23, 2024 - 04:17 AM</p>
      </div>
      <div class="footer-right">
        <p>¬© 2024 - Fourmula 1</p>
      </div>
    </div>

    <script></script>
  </body>
</html>
