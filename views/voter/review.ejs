<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Voting System</title>

    <link rel="stylesheet" type="text/css" href="voter/css/index_voter.css" />
    <link rel="stylesheet" type="text/css" href="voter/css/review.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet" />
  </head>

  <body>
    <header class="header">
      <div class="header-logo">
        <img src="img/logo_tanikala.png" alt="Tanikala Voting System" />
      </div>
      <nav class="header-nav">
        <ul class="header-nav-content">
          <li><a href="/vote">Vote</a></li>
          <li><a href="/review" id="active-link">Review</a></li>
          <li><a href="verify.html">Verify</a></li>
        </ul>
      </nav>
      <div class="header-bottom-line"></div>
    </header>

    <div class="content">
      <br />
      <div class="content-header">
        <div class="content-header-bulsu">
          <img src="img/logo_bulsu.png" />
        </div>
        <div class="content-header-text">
          <h1>BulSU Student Government Elections<br />S.Y. 2025 - 2026</h1>
        </div>
        <div class="content-header-ucse">
          <img src="img/logo_bulsu_ucse.png" />
        </div>
      </div>

      <div class="content-main">
        <p><i>Please REVIEW your votes before SUBMITTING BALLOT to the Blockchain</i></p>
        <br />
        <div class="review">
          <br />
          <h3 class="ballot-header ballot-council">Vote Summary</h3>

          <h3 class="ballot-header ballot-position">BulSU Supreme Student Council S.Y. 2025-2026</h3>
          <br />
          <ul>
            <li>
              <div class="card">
                <div class="smallIcon">
                  <div class="Icon"><img src="image-placeholder.jpg" /></div>
                  <div class="Name"><h2>President Name</h2></div>
                  <div class="Roles"><h2>President Position</h2></div>
                  <div class="Description"><p>Additional information about the president.</p></div>
                </div>
              </div>
            </li>
            <br />
            <li>
              <div class="card">
                <div class="smallIcon">
                  <div class="Icon"><img src="image-placeholder.jpg" /></div>
                  <div class="Name"><h2>Vice President Name</h2></div>
                  <div class="Roles"><h2>Vice President Position</h2></div>
                  <div class="Description"><p>Additional information about the vice president.</p></div>
                </div>
              </div>
            </li>
            <br />
            <li>
              <div class="senator-cards">
                <div class="card">
                  <div class="smallIcon">
                    <div class="Icon"><img src="image-placeholder.jpg" /></div>
                    <div class="Name"><h2>Senator Name</h2></div>
                    <div class="Roles"><h2>Senator Position</h2></div>
                    <div class="Description"><p>Additional information about the senator.</p></div>
                  </div>
                </div>
                <br />
              </div>
            </li>
            <li>
              <div class="card">
                <div class="smallIcon">
                  <div class="Icon"><img src="image-placeholder.jpg" /></div>
                  <div class="Name"><h2>Governor Name</h2></div>
                  <div class="Roles"><h2>Governor Position</h2></div>
                  <div class="Description"><p>Additional information about the governor.</p></div>
                </div>
              </div>
            </li>
            <br />
            <li>
              <div class="card">
                <div class="smallIcon">
                  <div class="Icon"><img src="image-placeholder.jpg" /></div>
                  <div class="Name"><h2>Vice Governor Name</h2></div>
                  <div class="Roles"><h2>Vice Governor Position</h2></div>
                  <div class="Description"><p>Additional information about the vice governor.</p></div>
                </div>
              </div>
            </li>
            <br />
            <li>
              <div class="card">
                <div class="smallIcon">
                  <div class="Icon"><img src="image-placeholder.jpg" /></div>
                  <div class="Name"><h2>Board Member Name</h2></div>
                  <div class="Roles"><h2>Board Member Position</h2></div>
                  <div class="Description"><p>Additional information about the board member.</p></div>
                </div>
              </div>
            </li>
            <br />
          </ul>
          <form id="voteForm">
            <input type="hidden" id="voterHash" value="20292002480@ms.bulsu.edu.ph" />

            <div class="button-container">
              <button class="button-back" type="button" onclick="window.location.href='/vote'">
                <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12H4.5m0 0l6.75-6.75M4.5 12l6.75 6.75"></path>
                </svg>
                <div class="text">Go Back</div>
              </button>

              <input type="hidden" id="voteData" value="Vote data placeholder" />
              <button type="button" id="submitBtn" value="Submit Votes to Blockchain" onclick="submitVote()" class="button">
                <span class="fold"></span>

                <div class="points_wrapper">
                  <i class="point"></i>
                  <i class="point"></i>
                  <i class="point"></i>
                  <i class="point"></i>
                  <i class="point"></i>
                  <i class="point"></i>
                  <i class="point"></i>
                  <i class="point"></i>
                  <i class="point"></i>
                  <i class="point"></i>
                </div>

                <span class="inner">
                  <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5">
                    <polyline points="13.18 1.37 13.18 9.64 21.45 9.64 10.82 22.63 10.82 14.36 2.55 14.36 13.18 1.37"></polyline>
                  </svg>
                  <span>Submit Votes</span>
                </span>
              </button>
            </div>
          </form>

          <br /><br />
          <hr />
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="footer-left">
        <p>OCTOBER 23, 2024 - 04:17 AM</p>
      </div>
      <div class="footer-right">
        <p>Â© 2024 - Fourmula 1</p>
      </div>
    </div>

    <script>
      async function submitVote(event) {
        if (event) event.preventDefault(); // Prevent form submission

        let votes = JSON.parse(document.getElementById("voteData").value);
        let voterHash = document.getElementById("voterHash").value;

        console.log("ðŸ“¡ Submitting Vote - Voter Hash:", voterHash); // Debug log

        if (!voterHash) {
          alert("âŒ Missing voter hash!");
          return;
        }

        let hashedVoterHash = await sha256(voterHash);
        console.log("ðŸ” Hashed Voter Hash:", hashedVoterHash);

        const voterCollege = "voterCollege placeholder";
        const voterProgram = "voterProgram placeholder";

        let formattedVotes = {
          President: votes.president,
          "Vice President": votes.vicePresident,
          Senator: votes.senator,
        };

        if (votes.governor) {
          formattedVotes[`Governor - ${voterCollege}`] = votes.governor;
        }
        if (votes.viceGovernor) {
          formattedVotes[`Vice Governor - ${voterCollege}`] = votes.viceGovernor;
        }
        if (votes.boardMember) {
          formattedVotes[`Board Member - ${voterProgram}`] = votes.boardMember;
        }

        console.log("ðŸ“¡ Sending Request to Server:", formattedVotes);

        try {
          let response = await fetch("/submit-vote", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ votes: formattedVotes, voterHash: hashedVoterHash, voterCollege, voterProgram }),
          });

          console.log("ðŸ“¡ Server Response:", response.status, response.statusText);

          if (response.ok) {
            let data = await response.json();
            console.log("âœ… Redirecting to", data.redirect);
            window.location.href = data.redirect;
          } else {
            let data = await response.json();
            console.error("âŒ Submission failed:", data.error);
            alert("âŒ Submission failed: " + data.error);
          }
        } catch (error) {
          console.error("âŒ Error submitting vote:", error);
          alert("âŒ Failed to submit votes. Please check the console for details.");
        }
      }

      async function sha256(input) {
        const encoder = new TextEncoder();
        const data = encoder.encode(input);
        const hashBuffer = await crypto.subtle.digest("SHA-256", data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map((byte) => byte.toString(16).padStart(2, "0")).join("");
      }
    </script>
  </body>
</html>
