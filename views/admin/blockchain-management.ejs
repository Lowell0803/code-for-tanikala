<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>BulSU Voting System</title>

    <link rel="stylesheet" type="text/css" href="admin/css/index-admin.css" />
    <link rel="stylesheet" type="text/css" href="admin/css/sidebar.css" />
    <link rel="stylesheet" type="text/css" href="admin/css/blockchain-management.css" />

    <!-- Boxicons CDN Link -->
    <link href="https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=upins:wght@400;700&display=swap" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  </head>

  <body>
    <%- include('header') %>

    <div class="content">
      <%- include('sidebar', { activeTab: 'blockchain', activeSub: 'blockchain-management' }) %>
      <main class="main">
        <div id="container-overlay">
          <div class="title-container">
            <div class="r">
              <i class="fa fa-link"></i>
              <h1 class="title">Blockchain Management</h1>
            </div>
             <h3 class="top">
                        <b>Blockchain Link:</b>
                        <% if (blockchainInfo && blockchainInfo.transactionHash) { %>
                          <a href="https://amoy.polygonscan.com/tx/<%= blockchainInfo.transactionHash %>#eventlog" target="_blank">
                            View Transaction
                          </a>
                        <% } else { %>
                          N/A
                        <% } %>
                        </h3>
          </div>
          <hr class="title-line" />

          <div class="column-main box-shadow">
            <div class="first-main">
              <div class="left">
                <h2>Blockchain Information</h2>
                <br />
                <div class="indent">
                  <ul>
                    <li>
                      <p><strong>Blockchain Network: </strong>Polygon</p>
                    </li>
                    <li>
                      <p><strong>Consensus Mechanism: </strong>Proof-of-stake (POS)</p>
                    </li>
                    <li>
                      <p><strong>Average Transaction Speed: </strong>2000 -4000 Transaction per Second</p>
                    </li>
                    <li>
                      <p><strong>Maximum Capacity: </strong>7000 Transaction per Second</p>
                    </li>
                  </ul>
                </div>
                <br />
                <%
                  // Compute Live Fee Estimate per Vote Transaction using blockchainMgmt data.
                  let liveFeeEstimatePOL = 0, liveFeeEstimateUSD = 0, liveFeeEstimatePHP = 0;
                  if (blockchainMgmt && blockchainMgmt.voteTransactionsCount > 0) {
                    liveFeeEstimatePOL = blockchainMgmt.totalAmountSpentPol / blockchainMgmt.voteTransactionsCount;
                    liveFeeEstimateUSD = blockchainMgmt.totalAmountSpentUSD / blockchainMgmt.voteTransactionsCount;
                    liveFeeEstimatePHP = blockchainMgmt.totalAmountSpentPHP / blockchainMgmt.voteTransactionsCount;
                  }

                  // Compute Live Recommended Fund Estimate using electionConfig.totalNumberOfStudents.
                  let recommendedFundPOL = 0, recommendedFundUSD = 0, recommendedFundPHP = 0;
                  if (electionConfig && electionConfig.totalNumberOfStudents && blockchainMgmt && blockchainMgmt.voteTransactionsCount > 0) {
                    recommendedFundPOL = liveFeeEstimatePOL * electionConfig.totalNumberOfStudents;
                    recommendedFundUSD = liveFeeEstimateUSD * electionConfig.totalNumberOfStudents;
                    recommendedFundPHP = liveFeeEstimatePHP * electionConfig.totalNumberOfStudents;
                  }

                  // Determine the current balance status based on walletInfo.balancePOL relative to recommendedFundPOL.
                  let balanceStatus = "";
                  let balanceDescription = "";
                  if (walletInfo) {
                    if (walletInfo.balancePOL > recommendedFundPOL * 1.5) {
                      balanceStatus = "Excellent";
                       balanceStatusClass = "balance-excellent";
                      balanceDescription = "The admin wallet balance is well above the recommended fund estimate. You have more than enough funds to execute the blockchain voting operation confidently.";
                    } else if (walletInfo.balancePOL >= recommendedFundPOL) {
                      balanceStatus = "Good";
                       balanceStatusClass = "balance-good";
                      balanceDescription = "The admin wallet balance matches the recommended fund estimate. You are in a stable position to proceed with the blockchain voting operation.";
                    } else {
                      balanceStatus = "Warning";
                        balanceStatusClass = "balance-warning";
                      balanceDescription = "The admin wallet balance is below the recommended fund estimate. Consider adding more funds to avoid potential issues during the blockchain voting operation.";
                    }
                  }
                %>

                <h2>Admin Wallet Information</h2>
                <br />
                <!-- Wallet Address -->
                <div class="indent">
                  <ul>
                    <li>
                      <p>
                        <strong>Wallet Address:</strong>
                        <%= walletInfo ? walletInfo.address : "N/A" %>
                      </p>
                    </li>
                    <br />
                    <li>
                      <p>
                        <strong>Current Balance:</strong>
                        <span class="<%= balanceStatusClass %>"><b><%= balanceStatus %></b></span>
                      </p>
                      <p class="small-text <%= balanceStatusClass %>"><em>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<%= balanceDescription %></em></p>
                    </li>
                    <br />
                    <table class="currency">
                      <tr>
                        <th>Polygon (POL)</th>
                        <th>United States Dollar (USD)</th>
                        <th>Philippine Peso (PHP)</th>
                      </tr>
                      <tr>
                        <td><%= walletInfo ? walletInfo.balancePOL.toFixed(4) : "N/A" %> POL</td>
                        <td><%= walletInfo && walletInfo.balanceUSD ? walletInfo.balanceUSD.toFixed(2) : "N/A" %> USD</td>
                        <td><span class="highlight"><%= walletInfo && walletInfo.balancePHP ? walletInfo.balancePHP.toFixed(2) : "N/A" %> PHP</span></td>
                      </tr>
                    </table>
                    <br />
                    <li>
                      <p>
                        <strong>Live Fee Estimate per Vote Transaction:</strong>
                        <span>
                          <%= (blockchainMgmt && blockchainMgmt.voteTransactionsCount > 0) ? liveFeeEstimatePOL.toFixed(4) : "0" %> POL |
                          <%= (blockchainMgmt && blockchainMgmt.voteTransactionsCount > 0) ? liveFeeEstimateUSD.toFixed(2) : "0" %> USD |
                         <span class="sub-highlight"> <%= (blockchainMgmt && blockchainMgmt.voteTransactionsCount > 0) ? liveFeeEstimatePHP.toFixed(2) : "0" %> PHP</span>
                        </span>
                      </p>
                    </li>
                    <br />
                    <li>
                      <p>
                        <strong>Live Recommended Fund Estimate:</strong>
                        <span>
                          <%= (blockchainMgmt && electionConfig && blockchainMgmt.voteTransactionsCount > 0) ? recommendedFundPOL.toFixed(4) : "0" %> POL |
                          <%= (blockchainMgmt && electionConfig && blockchainMgmt.voteTransactionsCount > 0) ? recommendedFundUSD.toFixed(2) : "0" %> USD |
                          <span class=highlight><%= (blockchainMgmt && electionConfig && blockchainMgmt.voteTransactionsCount > 0) ? recommendedFundPHP.toFixed(2) : "0" %> PHP</span>
                        </span>
                      </p>
                    </li>
                   <!-- <li>
                      <p>
                        <strong>Blockchain Link:</strong>
                        <% if (blockchainMgmt && blockchainMgmt.candidateSubmissionHash) { %>
                          <a href="https://amoy.polygonscan.com/tx/<%= blockchainMgmt.candidateSubmissionHash %>#eventlog" target="_blank">
                            View Transaction
                          </a>
                        <% } else { %>
                          N/A
                        <% } %>
                      </p>
                    </li> -->
                  </ul>
                </div>

              </div>

              <div class="right">
                <h2>Blockchain Transactions</h2>
                <br />
                <div class="indent">
                  <ul>
                    <li>
                      <p>
                        <strong>Candidate Submission Count: </strong>
                        <span><%= blockchainMgmt ? blockchainMgmt.candidateSubmissionsCount : "N/A" %></span>
                      </p>
                      <div class="indent-ish">
                        <p>
                          <strong>Latest Transaction Hash:</strong>
                          <%= blockchainMgmt && blockchainMgmt.candidateSubmissionHash ? blockchainMgmt.candidateSubmissionHash : "N/A" %>
                        </p>
                        <p>
                          <strong>Latest Submission Date:</strong>
                          <%= blockchainMgmt && blockchainMgmt.candidateSubmissionDate ? moment(blockchainMgmt.candidateSubmissionDate).format("MMMM DD, YYYY [AT] hh:mm A") : "N/A" %>
                        </p>
                      </div>
                    </li>
                    <br />
                    <li>
                      <p>
                        <strong>Vote Transactions Count: </strong>
                        <span><%= blockchainMgmt ? blockchainMgmt.voteTransactionsCount : "N/A" %></span>
                      </p>
                    </li>
                    <br />
                    <li>
                      <p>
                        <strong>Total Blockchain Transactions: </strong>
                        <span>
                          <%= blockchainMgmt ? (blockchainMgmt.voteTransactionsCount + blockchainMgmt.candidateSubmissionsCount) : "N/A" %>
                        </span>
                      </p>
                      <div class="indent-ish">
                        <p>
                          <strong>Total Gas Used:</strong>
                          <%= blockchainMgmt ? blockchainMgmt.totalGasUsed : "N/A" %> Gas
                        </p>
                        <p>
                          <strong>Total Amount Spent (Wei):</strong>
                          <%= blockchainMgmt ? blockchainMgmt.totalWeiSpent : "N/A" %> Wei
                        </p>
                        <br />
                        <p><strong>Total Amount Spent:</strong></p>
                      </div>
                    </li>
                    <br />
                    <table class="currency">
                      <tr>
                        <th>Polygon (POL)</th>
                        <th>United States Dollar (USD)</th>
                        <th>Philippine Peso (PHP)</th>
                      </tr>
                      <tr>
                        <td>
                          <%= blockchainMgmt && blockchainMgmt.totalAmountSpentPol !== undefined
                            ? blockchainMgmt.totalAmountSpentPol.toFixed(6)
                            : "N/A" %> POL
                        </td>
                        <td>
                          <%= blockchainMgmt && blockchainMgmt.totalAmountSpentUSD !== undefined
                            ? blockchainMgmt.totalAmountSpentUSD.toFixed(2)
                            : "N/A" %> USD
                        </td>
                        <td>
                          <span class="highlight"><%= blockchainMgmt && blockchainMgmt.totalAmountSpentPHP !== undefined
                            ? blockchainMgmt.totalAmountSpentPHP.toFixed(2)
                            : "N/A" %> PHP </span>
                        </td>
                      </tr>
                    </table>
                    <br />
                  </ul>
                </div>
              </div>
              
            </div>
            <div class="update-date">
              <p>All Data Last Updated on <strong><%= walletInfo ? moment(walletInfo.updatedAt).format("MMMM DD, YYYY [AT] hh:mm A") : "N/A" %></strong></p>
            </div>
          </div>
        </div>
      </main>
    </div>

    <%- include('footer') %>

    <script src="admin/js/sidebar.js"></script>
    <script src="admin/js/index-admin.js"></script>
    <script src="js/dropdown.js"></script>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      // Connect to Socket.IO, passing the logged-in admin's email
      const socket = io("/", { query: { email: "<%= loggedInAdmin.email %>" } });
    </script>
  </body>
</html>
